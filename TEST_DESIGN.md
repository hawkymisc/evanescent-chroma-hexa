# テスト設計書 - Evanescent Chroma Hexa

## 1. テスト対象関数一覧

### 1.1 ユーティリティ関数
| 関数名 | 責務 | 入力 | 出力 |
|--------|------|------|------|
| `hexToPixel(q, r)` | Axial座標→ピクセル座標変換 | q: number, r: number | {x: number, y: number} |
| `coordKey(q, r)` | 座標キー生成 | q: number, r: number | string |
| `getNeighbors(q, r)` | 隣接6方向の座標取得 | q: number, r: number | Array<{q, r}> |
| `randomColor()` | ランダム色生成 | なし | 0-3の整数 |

### 1.2 ゲームロジック関数
| 関数名 | 責務 | 入力 | 出力 |
|--------|------|------|------|
| `findGroup(startQ, startR)` | BFSで同色隣接グループ検出 | q: number, r: number | Array<Tile> |
| `applyGravity()` | 縦列単純落下処理 | なし | void (状態変更) |
| `checkGameOver()` | ゲーム終了判定 | なし | void (状態変更) |
| `initGrid()` | グリッド初期化 | なし | void (状態変更) |

---

## 2. 境界値分析

### 2.1 座標系の境界値

#### hexToPixel(q, r)
| テストケース | q | r | 期待される動作 |
|-------------|---|---|---------------|
| 最小値 | 0 | 0 | {x: 0, y: 0} |
| 中央値 | 4 | 4 | 正常な座標 |
| 最大値 | 7 | 8 | グリッド範囲内 |
| 境界外（負） | -1 | -1 | 計算は実行されるが表示範囲外 |
| 境界外（正） | 8 | 9 | グリッド範囲外 |

#### getNeighbors(q, r)
| テストケース | q | r | 隣接数 | 備考 |
|-------------|---|---|--------|------|
| 左上角 | 0 | 0 | 6 | 範囲外座標を含む |
| 右下角 | 7 | 8 | 6 | 範囲外座標を含む |
| 中央 | 4 | 4 | 6 | 全て範囲内 |
| 左端 | 0 | 4 | 6 | 一部範囲外 |
| 右端 | 7 | 4 | 6 | 一部範囲外 |

### 2.2 グループサイズの境界値

#### findGroup(startQ, startR)
| テストケース | グループサイズ | 期待される動作 |
|-------------|---------------|---------------|
| 孤立タイル | 1 | グループサイズ1を返す |
| 最小消去可能 | 2 | グループサイズ2を返す |
| 小グループ | 3-5 | 正確にグループを検出 |
| 大グループ | 10+ | 正確にグループを検出 |
| 全タイル同色 | 72 (8×9) | 全タイルを返す |

### 2.3 スコア計算の境界値

公式: `score = (n - 2)²`

| タイル数 (n) | スコア | 備考 |
|-------------|--------|------|
| 0 | - | 発生しない |
| 1 | - | 消去不可 |
| 2 | 0 | 最小消去 |
| 3 | 1 | |
| 4 | 4 | |
| 5 | 9 | |
| 10 | 64 | |
| 20 | 324 | |
| 72 | 4900 | 最大（全消し） |

### 2.4 グリッドサイズの境界値

| テストケース | タイル数 | 期待される動作 |
|-------------|---------|---------------|
| 空グリッド | 0 | ゲーム終了 |
| タイル1個 | 1 | ゲーム終了（消去不可） |
| タイル2個（同色隣接） | 2 | 消去可能 |
| タイル2個（異色） | 2 | ゲーム終了 |
| フルグリッド | 72 | 正常動作 |

---

## 3. 状態遷移表

### 3.1 ゲーム状態遷移

| 現在の状態 | イベント | 条件 | 次の状態 | アクション |
|-----------|---------|------|---------|-----------|
| 未初期化 | ページロード | - | プレイ中 | initGrid(), renderGrid() |
| プレイ中 | タイルクリック | グループサイズ < 2 | プレイ中 | なし |
| プレイ中 | タイルクリック | グループサイズ >= 2, 残り手あり | プレイ中 | タイル消去、重力、スコア加算 |
| プレイ中 | タイルクリック | グループサイズ >= 2, 残り手なし | ゲーム終了 | タイル消去、重力、スコア加算、終了表示 |
| プレイ中 | 新規ゲームボタン | - | プレイ中 | initGrid(), スコアリセット |
| ゲーム終了 | タイルクリック | - | ゲーム終了 | なし（無視） |
| ゲーム終了 | リスタートボタン | - | プレイ中 | initGrid(), スコアリセット |

### 3.2 タイル状態遷移

| 現在の状態 | イベント | 次の状態 | アクション |
|-----------|---------|---------|-----------|
| 存在 | マウスオーバー（グループサイズ >= 2） | ハイライト | CSS class追加 |
| ハイライト | マウスアウト | 存在 | CSS class削除 |
| ハイライト | クリック | 削除済み | DOM削除、Map削除 |
| 削除済み | 重力処理 | - | - |
| 存在（上方） | 下方タイル削除 + 重力 | 存在（下方） | r座標更新 |

---

## 4. 同値分割

### 4.1 タイルの色

| クラス | 値 | 有効/無効 |
|--------|---|----------|
| 有効な色 | 0, 1, 2, 3 | 有効 |
| 無効な色（負） | -1 | 無効 |
| 無効な色（範囲外） | 4以上 | 無効 |

### 4.2 座標の範囲

| 軸 | 有効範囲 | 境界内 | 境界外（下） | 境界外（上） |
|----|---------|--------|-------------|-------------|
| q | 0-7 | 0, 3, 7 | -1 | 8 |
| r | 0-8 | 0, 4, 8 | -1 | 9 |

---

## 5. テストケース設計

### 5.1 coordKey(q, r)

| ID | 入力 (q, r) | 期待出力 | テスト種別 |
|----|------------|---------|-----------|
| CK-1 | (0, 0) | "0,0" | 境界値 |
| CK-2 | (7, 8) | "7,8" | 境界値 |
| CK-3 | (4, 4) | "4,4" | 正常値 |
| CK-4 | (-1, -1) | "-1,-1" | 境界外 |

### 5.2 hexToPixel(q, r)

| ID | 入力 (q, r) | 期待出力 (x, y) | テスト種別 |
|----|------------|----------------|-----------|
| HP-1 | (0, 0) | (0, 0) | 境界値 |
| HP-2 | (1, 0) | (45, 25.98) | 正常値 |
| HP-3 | (0, 1) | (0, 51.96) | 正常値 |
| HP-4 | (7, 8) | (315, 505.77) | 境界値 |

### 5.3 getNeighbors(q, r)

| ID | 入力 (q, r) | 期待される隣接数 | グリッド内隣接数 | テスト種別 |
|----|------------|----------------|----------------|-----------|
| GN-1 | (0, 0) | 6 | 2 (右, 右下) | 左上角 |
| GN-2 | (7, 8) | 6 | 2 (左, 左上) | 右下角 |
| GN-3 | (4, 4) | 6 | 6 (全方向) | 中央 |
| GN-4 | (0, 4) | 6 | 3-4 | 左端 |
| GN-5 | (7, 4) | 6 | 3-4 | 右端 |

### 5.4 findGroup(startQ, startR)

| ID | 初期状態 | 入力 (q, r) | 期待グループサイズ | テスト種別 |
|----|---------|------------|------------------|-----------|
| FG-1 | 全タイル異色 | (0, 0) | 1 | 孤立タイル |
| FG-2 | 横2個同色 | (0, 0) | 2 | 最小グループ |
| FG-3 | L字3個同色 | (0, 0) | 3 | 小グループ |
| FG-4 | 全タイル同色 | (4, 4) | 72 | 全体グループ |
| FG-5 | 存在しない座標 | (8, 9) | 0 | 境界外 |
| FG-6 | 削除済み座標 | (削除済み) | 0 | 削除済み |

### 5.5 applyGravity()

| ID | 初期状態 | 期待される動作 | テスト種別 |
|----|---------|---------------|-----------|
| AG-1 | 列0の下半分削除 | 上半分が下に落ちる | 基本動作 |
| AG-2 | 列0が全削除 | 空列のまま | 空列処理 |
| AG-3 | 全列でランダム削除 | 各列独立して落下 | 複数列 |
| AG-4 | 削除なし | 何も変化しない | 変化なし |

### 5.6 checkGameOver()

| ID | 初期状態 | 期待結果 | テスト種別 |
|----|---------|---------|-----------|
| CO-1 | 全タイル異色 | gameOver = true | ゲーム終了 |
| CO-2 | 2個以上の同色隣接あり | gameOver = false | 継続可能 |
| CO-3 | タイル1個のみ | gameOver = true | 最小タイル |
| CO-4 | タイル0個 | gameOver = true | 空グリッド |
| CO-5 | 同色だが非隣接 | gameOver = true | 隣接なし |

---

## 6. 統合テストシナリオ

### 6.1 正常系フロー

| ステップ | アクション | 期待結果 |
|---------|-----------|---------|
| 1 | ページロード | グリッドが表示される、スコア0 |
| 2 | 消去可能タイルにマウスオーバー | ハイライト表示 |
| 3 | タイルクリック（3個グループ） | タイル消去、スコア+1 |
| 4 | 重力処理後 | タイルが下に移動 |
| 5 | 別のタイルクリック（5個グループ） | スコア+9（累計10） |
| 6 | 消去不可タイルクリック | 何も起こらない |
| 7 | 最後のグループ消去 | ゲーム終了表示 |
| 8 | リスタートボタン | 新しいゲーム開始 |

### 6.2 異常系フロー

| ステップ | アクション | 期待結果 |
|---------|-----------|---------|
| 1 | ゲーム終了後にタイルクリック | 何も起こらない |
| 2 | 範囲外座標への操作試行 | エラーなく無視される |
| 3 | 連続クリック（ダブルクリック） | 正常に処理される |

---

## 7. カバレッジ目標

### 7.1 関数カバレッジ
- **目標**: 100%（全関数をテスト）

### 7.2 行カバレッジ
- **目標**: 90%以上

### 7.3 分岐カバレッジ
- **目標**: 85%以上（全if/else分岐）

### 7.4 境界値カバレッジ
- **目標**: 100%（全境界値パターン）

---

## 8. テスト実装方針

### 8.1 ユニットテスト
- 各関数を独立してテスト
- DOM操作が必要な関数はモック化

### 8.2 統合テスト
- ゲームフロー全体をテスト
- 実際のDOM環境で実行

### 8.3 テストフレームワーク
- **候補**: Mocha + Chai (ブラウザ対応)
- または、軽量な自作アサーション

---

## 9. テストデータ設計

### 9.1 固定グリッドパターン

```javascript
// パターン1: 最小消去可能（横2個）
const pattern1 = [
  [0, 0, 1, 1, 2, 2, 3, 3], // 行0
  [1, 1, 0, 0, 3, 3, 2, 2], // 行1
  // ...
];

// パターン2: 全タイル同色
const pattern2 = Array(9).fill(Array(8).fill(0));

// パターン3: 全タイル異色（市松模様）
const pattern3 = /* 市松模様の配置 */;
```

---

## 10. リグレッションテスト

### 10.1 クリティカルパス
1. グリッド初期化
2. グループ検出
3. タイル消去
4. 重力処理
5. ゲーム終了判定

### 10.2 エッジケース
1. 空グリッド
2. 全タイル同色
3. 全タイル異色
4. 1タイルのみ

---

## 11. パフォーマンステスト

| テスト項目 | 目標 | 測定方法 |
|-----------|------|---------|
| findGroup実行時間 | < 10ms | performance.now() |
| applyGravity実行時間 | < 5ms | performance.now() |
| renderGrid実行時間 | < 100ms | performance.now() |

---

## 更新履歴

- 2025-10-26: 初版作成（境界値分析、状態遷移表、テストケース設計）
